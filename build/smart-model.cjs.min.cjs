/*! SmartModel v0.3.2 */
"use strict";function isArray(e){return Array.isArray(e)}function isUndef(e){return void 0===e}function isEmpty(e){return""===e||null===e||isUndef(e)}function isFn(e){return"function"==typeof e}function isEqual(e,t){return JSON.stringify(e)===JSON.stringify(t)}function isClass(e){return e&&e.toString().startsWith("class")}function isPlainObject(e){return e&&"[object Object]"===e.toString()}function isType(e,t){const r=t&&t.toString().match(/^\s*function (\w+)/),n=(r?r[1]:"object").toLowerCase();if("date"===n&&e instanceof t)return!0;if("array"===n&&isArray(e))return!0;if("object"===n){if(isClass(t)&&e instanceof t)return!0;if(!isClass(t)&&typeof e===n)return!0}else if(typeof e===n)return!0;return!1}function merge(e,t){return t=Object.assign({},e,t),Object.keys(e).forEach((r=>{isPlainObject(e[r])&&isPlainObject(t[r])&&(t[r]=Object.assign({},e[r],merge(e[r],t[r])))})),t}function toArray(e){return[].concat([],e)}function pascalCase(e){return e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").match(/[a-z]+/gi).map((e=>e.charAt(0).toUpperCase()+e.substr(1).toLowerCase())).join("")}class SmartModelError extends Error{constructor(e){super(e.message),Object.assign(this,e)}}function checkErrors(e,t,r,n,o={}){const s=[];return!o.strict||e&&Object.keys(e).length||s.push({message:`Property "${t}" can't be set in strict mode`,code:"strict"}),e.required&&isEmpty(r)?(s.push({message:`Property "${t}" is "required"`,code:"required"}),s):e.readonly&&!n?(s.push({message:`Property '${t}' is 'readonly'`,code:"readonly"}),s):(void 0===r||(!e.type||!e.required&&isEmpty(r)||toArray(e.type).some((e=>isType(r,e)))||s.push({message:`Property "${t}" has an invalid type "${typeof r}"`,code:"type"}),e.rule&&Object.keys(e.rule).forEach((n=>{(0,e.rule[n])(r)&&s.push({message:`Property "${t}" breaks the "${n}" rule`,code:"rule:"+n})}))),s)}function createNested(e={},t,r){if(!e.type)return!1;const n=e.type.prototype instanceof SmartModel&&e.type,o=!!isPlainObject(e.type)&&e.type;return!(!n&&!o)&&(n||SmartModel.create(pascalCase(t),o,r))}SmartModelError.throw=function(e,t,r,n,o){const s=t.split(":")[0];if(!0===e.exceptions||isPlainObject(e.exceptions)&&e.exceptions[s])throw new SmartModelError({message:r,property:n,code:t,source:o&&o.constructor.name})};class SmartModelProxy{constructor(e,t){return new Proxy(this,{set(r,n,o){const s=e[n]||{},c=r[n],i=isUndef(c),a=!i&&!isEqual(o,c),u=createNested(s,n,t);function l(t,s){return Reflect.apply(t,r,s||[n,o,c,e])}if(l(r.onBeforeSet),a&&l(r.onBeforeUpdate),isFn(s.transform)&&(o=l(s.transform,[o,e])),t.exceptions){const e=checkErrors(s,n,o,i,t);e.length&&SmartModelError.throw(t,e[0].code,e[0].message,n,r)}return!(!t.strict||s&&Object.keys(s).length)||(u&&(o=new u(o instanceof Object?o:{})),r[n]=o,l(r.onSet),a&&l(r.onUpdate),!0)},get(t,r){const n=e[r];let o=t[r];if(!n)return t[r];function s(n,s){return Reflect.apply(n,t,s||[r,o,e])}return s(t.onBeforeGet),isFn(n)&&(o=s(n,[t,e])),isFn(n.format)&&(o=s(n.format,[o,e])),s(t.onGet),o},deleteProperty(t,r){const n=t[r];function o(o,s){return Reflect.apply(o,t,s||[r,n,e])}if(e[r].required)throw new SmartModelError({message:`Invalid delete on required propery ${r}`,property:r,code:"required"});return o(t.onBeforeDelete),Reflect.deleteProperty(t,r),o(t.onDelete),o(t.onUpdate),!0}})}}class SmartModel extends SmartModelProxy{constructor(e={},t={},r){super(e,r),Object.keys(e).forEach((r=>{isUndef(t[r])&&(this[r]=isUndef(e[r].default)?t[r]:e[r].default)})),this.feed(t)}feed(e){Object.keys(e).forEach((t=>{this[t]=e[t]}))}onBeforeGet(){}onBeforeSet(){}onBeforeUpdate(){}onDelete(){}onGet(){}onBeforeDelete(){}onSet(){}onUpdate(){}}SmartModel.settings={strict:!1,exceptions:{readonly:!1,required:!0,rule:!0,strict:!1,type:!0}},SmartModel.create=function(e,t,r,n){r=merge(SmartModel.settings,r);const o={[e]:class extends SmartModel{constructor(e){super(t,e,r)}}}[e];return o.checkErrors=function(e,n){const o={};return Object.keys(t).forEach((s=>{let c;const i=e[s],a=t[s],u=createNested(a,s,r);u&&(c=u.checkErrors(i,n));let l=checkErrors(a,s,i,!1);c?o[s]=c:l.length&&(n&&(l=l.filter((e=>!toArray(n).includes(e.code)))),l.length&&(o[s]=l))})),!!Object.keys(o).length&&o},o.hydrate=function(e){return isArray(e)?e.map((e=>new o(e))):new o(e)},Object.assign(o.prototype,n),o.schema=t,o},module.exports=SmartModel;
