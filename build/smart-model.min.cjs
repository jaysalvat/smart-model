/*! SmartModel v0.3.1 */
"use strict";class SmartModelError extends Error{constructor(e){super(e.message),Object.assign(this,e)}}function isArray(e){return Array.isArray(e)}function isUndef(e){return void 0===e}function isEmpty(e){return""===e||null===e||isUndef(e)}function isFn(e){return"function"==typeof e}function isEqual(e,t){return JSON.stringify(e)===JSON.stringify(t)}function isClass(e){return e.toString().startsWith("class")}function isPlainObject(e){return"[object Object]"===e.toString()}function isType(e,t){const r=t&&t.toString().match(/^\s*function (\w+)/),n=(r?r[1]:"object").toLowerCase();if("date"===n&&e instanceof t)return!0;if("array"===n&&isArray(e))return!0;if("object"===n){if(isClass(t)&&e instanceof t)return!0;if(!isClass(t)&&typeof e===n)return!0}else if(typeof e===n)return!0;return!1}function toArray(e){return[].concat([],e)}function pascalCase(e){return e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").match(/[a-z]+/gi).map((e=>e.charAt(0).toUpperCase()+e.substr(1).toLowerCase())).join("")}function checkErrors(e,t,r){const n=[];return e.required&&isEmpty(r)?(n.push({message:`Invalid value 'required' on property '${t}'`,code:"required"}),n):(void 0===r||(!e.type||!e.required&&isEmpty(r)||toArray(e.type).some((e=>isType(r,e)))||n.push({message:`Invalid type '${typeof r}' on property '${t}'`,code:"type"}),e.rule&&Object.keys(e.rule).forEach((o=>{(0,e.rule[o])(r)&&n.push({message:`Invalid value '${o}' on property '${t}'`,code:o})}))),n)}function createNested(e={},t,r){if(!e.type)return!1;const n=e.type.prototype instanceof SmartModel&&e.type,o=!!isPlainObject(e.type)&&e.type;return!(!n&&!o)&&(n||SmartModel.create(pascalCase(t),o,r))}class SmartModelProxy{constructor(e,t){return new Proxy(this,{set(r,n,o){let s=e[n];const c=r[n],i=!isEqual(o,c),a=createNested(s,n,t);function u(t,s){return Reflect.apply(t,r,s||[n,o,c,e])}if(!s){if(t.strict)return!0;s={}}if(u(r.onBeforeSet),i&&u(r.onBeforeUpdate),isFn(s.transform)&&(o=u(s.transform,[o,e])),t.exceptions){const e=checkErrors(s,n,o);if(e.length)throw new SmartModelError({message:e[0].message,property:n,code:e[0].code,source:r.constructor.name})}return a&&(o=new a(o instanceof Object?o:{})),r[n]=o,u(r.onSet),i&&u(r.onUpdate),!0},get(t,r){const n=e[r];let o=t[r];if(!n)return t[r];function s(n,s){return Reflect.apply(n,t,s||[r,o,e])}return s(t.onBeforeGet),isFn(n)&&(o=s(n,[t,e])),isFn(n.format)&&(o=s(n.format,[o,e])),s(t.onGet),o},deleteProperty(t,r){const n=t[r];function o(o,s){return Reflect.apply(o,t,s||[r,n,e])}if(e[r].required)throw new SmartModelError({message:`Invalid delete on required propery ${r}`,property:r,code:"required"});return o(t.onBeforeDelete),Reflect.deleteProperty(t,r),o(t.onDelete),o(t.onUpdate),!0}})}}class SmartModel extends SmartModelProxy{constructor(e={},t={},r){super(e,r),Object.keys(e).forEach((r=>{isUndef(t[r])&&(this[r]=isUndef(e[r].default)?t[r]:e[r].default)})),this.feed(t)}feed(e){Object.keys(e).forEach((t=>{this[t]=e[t]}))}onBeforeGet(){}onBeforeSet(){}onBeforeUpdate(){}onDelete(){}onGet(){}onBeforeDelete(){}onSet(){}onUpdate(){}}SmartModel.settings={strict:!1,exceptions:!0},SmartModel.create=function(e,t,r,n){r=Object.assign({},SmartModel.settings,r);const o={[e]:class extends SmartModel{constructor(e){super(t,e,r)}}}[e];return o.checkErrors=function(e,n){const o={};return Object.keys(t).forEach((s=>{let c;const i=e[s],a=t[s],u=createNested(a,s,r);u&&(c=u.checkErrors(i,n));let f=checkErrors(a,s,i);c?o[s]=c:f.length&&(n&&(f=f.filter((e=>!toArray(n).includes(e.code)))),f.length&&(o[s]=f))})),!!Object.keys(o).length&&o},o.hydrate=function(e){return isArray(e)?e.map((e=>new o(e))):new o(e)},Object.assign(o.prototype,n),o.schema=t,o},module.exports=SmartModel;
